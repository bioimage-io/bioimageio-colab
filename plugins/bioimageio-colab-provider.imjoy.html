<config lang="json">
{
  "name": "BioImage.IO Colab Annotator",
  "type": "iframe",
  "tags": [],
  "ui": "",
  "version": "0.1.0",
  "cover": "",
  "description": "Collaborative Annotator for BioImage.IO with Automated Segmentation",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "api_version": "0.1.8",
  "env": "",
  "permissions": [],
  "requirements": [
    "https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.6/dist/hypha-rpc-websocket.min.js",
    "https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js",
    "https://cdn.jsdelivr.net/pyodide/v0.18.1/full/pyodide.js"
  ],
  "dependencies": []
}
</config>

<script lang="javascript">
class BioImageIOColabAnnotator {
    constructor() {
        this.image = null; // Current image
        this.mask = null; // Current mask
        this.filename = null; // Filename of the current image
        this.newname = null; // New name for the annotation file
        this.imageLayer = null; // Layer displaying the image
        this.annotationLayer = null; // Layer displaying the annotations
        this.edgeColor = "magenta"; // Default edge color for annotations
    }

    async setup() {
        // No setup actions required for now
    }

    async loadScript(url) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    async run(ctx) {
        // Create and display the viewer window
        const viewer = await api.createWindow({src: "https://kaibu.org/#/app", fullscreen: true});
        
        // Load the imjoy-rpc library
        await api.showMessage("Loading imjoy-rpc library...");
        await this.loadScript("https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.6/dist/hypha-rpc-websocket.min.js");
        const { login, connectToServer } = window.hypha;
        await api.showMessage("imjoy-rpc library loaded.");


        const server_url = "https://hypha.aicell.io"
        // token = await login({"server_url": server_url, "key": "bioimageio-colab"})
        // server = await connect_to_server({"server_url": server_url, "token": token})

        const server = await connect_to_server({"server_url": server_url});
        // await login(server, {username: "your_username", password: "your_password"});
        await api.showMessage("Connected to Hypha server.");

        // // Load Pyodide
        // await api.showMessage("Loading Pyodide...");
        // let pyodide = await loadPyodide({
        //     indexURL: "https://cdn.jsdelivr.net/pyodide/v0.18.1/full/"
        // });
        // await api.showMessage("Pyodide loaded.");

        // // You can still run some Python code if needed
        // await api.showMessage("Running Python code...");
        // let output = await pyodide.runPythonAsync(`
        //     print("Hello from Pyodide!")
        // `);
        
        // // Display the output
        // await api.showMessage(`Output: ${output}`);
    }
}

// Export the annotator class
api.export(new BioImageIOColabAnnotator());
</script>
