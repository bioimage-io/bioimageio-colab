<docs>
[TODO: write documentation for this plugin.]
</docs>

<config lang="json">
{
  "name": "BioImage.IO Colab Annotator",
  "type": "iframe",
  "tags": [],
  "ui": "",
  "version": "0.1.0",
  "cover": "",
  "description": "Collabrative Annotator for BioImage.IO",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "api_version": "0.1.8",
  "env": "",
  "permissions": [],
  "requirements": ["https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.6/dist/hypha-rpc-websocket.min.js"],
  "dependencies": []
}
</config>

<script lang="javascript">
class BioImageIOCrowdSourcing {
    constructor() {
        this.image = null;
        this.mask = null;
        this.filename = null;
        this.newname = null;
        this.imageLayer = null;
        this.annotationLayer = null;
    }

    async setup() {
        const viewer = await api.createWindow({src: "https://kaibu.org/#/app", fullscreen: true});
        await api.showMessage("Connecting to server....");
        try{
            const server = await hyphaWebsocketClient.connectToServer({server_url: "https://ai.imjoy.io"});
            this.biocolab = await server.getService("biocolab");
        }
        catch(e){
            await api.alert("Failed to get the biocolab service, please make sure you started the server.")
            return;
        }

        // Define image reading and displaying function
        const getImage = async () => {
            if (this.image !== null) {
                await viewer.removeLayer({id: this.imageLayer.id});
                await viewer.removeLayer({id: this.annotationLayer.id});
            }

            [this.image, this.filename, this.newname] = await this.biocolab.getRandomImage();
            this.imageLayer = await viewer.viewImage(this.image, {name: "image"});
            // Add the annotation functionality to the interface
            this.annotationLayer = await viewer.addShapes([], {
                shape_tpe: "polygon",
                draw_edge_color: "magenta",
                name: "annotation",
            });
        };

        const saveAnnotation = async () => {
            const annotation = await this.annotationLayer.getFeatures();
            if(annotation.features.length > 0){   
                await this.biocolab.saveAnnotation(this.filename, this.newname, features, [this.image.shape[0], this.image.shape[1]]);
                await api.showMessage("Annotation Saved to " + this.filename);
            }
            else{
                await api.showMessage("Skip saving annotation");
            }
            
        };

        const nextImage = async (option) => {
            await getImage();
            await saveAnnotation();
        };

        await viewer.add_widget({
            _rintf: true,
            name: "Control",
            type: "control",
            elements: [
                {
                    type: "button",
                    label: "Next Image",
                    callback: nextImage,
                }
            ],
        });

        await api.showMessage("Ready to annotate!");
    }
}

api.export(new BioImageIOCrowdSourcing());
</script>
