<docs>
[TODO: write documentation for this plugin.]
</docs>

<config lang="json">
{
  "name": "BioImage.IO Colab Annotator",
  "type": "iframe",
  "tags": [],
  "ui": "",
  "version": "0.1.0",
  "cover": "",
  "description": "Collabrative Annotator for BioImage.IO",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "api_version": "0.1.8",
  "env": "",
  "permissions": [],
  "requirements": ["https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.6/dist/hypha-rpc-websocket.min.js"],
  "dependencies": []
}
</config>

<script lang="javascript">
class BioImageIOColabAnnotator {
    constructor() {
        this.image = null;
        this.mask = null;
        this.filename = null;
        this.newname = null;
        this.imageLayer = null;
        this.annotationLayer = null;
    }

    async setup() {
    }
    
    async run(ctx){
        const config = ctx.config || {};
        const serviceId = config.service_id || "biocolab";
        const serverUrl = config.server_url || "https://ai.imjoy.io";
        const viewer = await api.createWindow({src: "https://kaibu.org/#/app", fullscreen: true});
        await api.showMessage(`Connecting to server ${serverUrl}....`);
        try{
            const server = await hyphaWebsocketClient.connectToServer({server_url: serverUrl, token: config.token, workspace: config.workspace});
            this.biocolab = await server.getService(serviceId);
        }
        catch(e){
            await api.alert(`Failed to get the bioimageio-colab service (id=${serviceId}), please make sure you started the server.`)
            return;
        }

        // Define image reading and displaying function
        const getImage = async () => {
            if (this.image !== null) {
                await viewer.remove_layer({id: this.imageLayer.id});
                await viewer.remove_layer({id: this.annotationLayer.id});
            }

            [this.image, this.filename, this.newname] = await this.biocolab.get_random_image();
            this.imageLayer = await viewer.view_image(this.image, {name: "image"});
            // Add the annotation functionality to the interface
            this.annotationLayer = await viewer.add_shapes([], {
                shape_tpe: "polygon",
                draw_edge_color: "magenta",
                name: "annotation",
            });
        };

        const saveAnnotation = async () => {
            if(!this.annotationLayer) return;
            const annotation = await this.annotationLayer.get_features();
            if(annotation.features.length > 0){
                await this.biocolab.save_annotation(this.filename, this.newname, annotation, [this.image._rshape[0], this.image._rshape[1]]);
                await api.showMessage("Annotation Saved to " + this.filename);
            }
            else{
                await api.showMessage("Skip saving annotation");
            }
            
        };

        const nextImage = async (option) => {
            await saveAnnotation();
            await getImage();
        };

        await viewer.add_widget({
            _rintf: true,
            name: "Control",
            type: "control",
            elements: [
                {
                    type: "button",
                    label: "Next Image",
                    callback: nextImage,
                }
            ],
        });

        await api.showMessage("Ready to annotate!");
    }
}

api.export(new BioImageIOColabAnnotator());
</script>
