<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioImage.IO Colab</title>
    <script src="https://cdn.jsdelivr.net/npm/hypha-rpc@0.20.83/dist/hypha-rpc-websocket.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --color-primary: #2C3E50;
            --color-secondary: #18BC9C;
            --color-accent: #3498DB;
            --color-warning: #E74C3C;
            --color-light: #ECF0F1;
            --color-dark: #2C3E50;
            --color-purple: #9B59B6;
            --color-green: #27AE60;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            color: var(--color-dark);
        }

        .bg-primary {
            background-color: var(--color-primary);
        }

        .bg-secondary {
            background-color: var(--color-secondary);
        }

        .bg-accent {
            background-color: var(--color-accent);
        }

        .bg-purple {
            background-color: var(--color-purple);
        }

        .bg-green {
            background-color: var(--color-green);
        }

        .bg-disabled-button {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .bg-hover:hover {
            background-color: rgba(52, 152, 219, 0.7);
        }

        .btn-click-effect:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        .spinner-border {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--color-secondary);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s infinite linear;
        }

        .floating-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 9999;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .tab-active {
            background-color: var(--color-secondary);
            border-radius: 0.5rem;
            color: white;
        }

        .separator {
            border-top: 1px solid #555;
            margin: 1rem 0;
        }

        .progress-bar {
            background-color: var(--color-accent);
            height: 1rem;
            border-radius: 0.5rem;
        }

        .info-box {
            background-color: var(--color-light);
            border-left: 4px solid var(--color-accent);
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }

        .info-box-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .info-box-text {
            font-size: 1rem;
            color: var(--color-dark);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
    </style>
    <script src="./worker-manager.js"></script>
</head>

<body>
    <script type="module">
        import { get, set } from "https://cdn.jsdelivr.net/npm/idb-keyval@6/+esm";
        window.getFromDB = get;
        window.saveToDB = set;
    </script>
    <div id="app"></div>
    <script type="text/babel" data-presets="env,react">

        const { useState, useEffect } = React;

        const serverUrl = "https://hypha.aicell.io";
        const serviceFile = "data_service.py";
        const pluginUrl = "https://raw.githubusercontent.com/bioimage-io/bioimageio-colab/main/plugins/bioimageio-colab-annotator.imjoy.html";  // Update to main branch
        let workerPromise;

        function App() {
            const [user, setUser] = useState({});
            const [isRunning, setIsRunning] = useState(false);
            const [pyodideOutput, setPyodideOutput] = useState([]);
            const [supportedFileTypes, setSupportedFileTypes] = useState([".tiff", ".tif"]);
            const [artifactManager, setArtifactManager] = useState(null);

            useEffect(() => {
                async function loadSupportedFileTypes() {
                    try {
                        const response = await fetch(`./${serviceFile}`);
                        const text = await response.text();
                        const match = text.match(/class ImageFormat\(str, Enum\):([\s\S]*?)(?=\n\n|\n[A-Z]|$)/);
                        if (match) {
                            const content = match[1];
                            const regex = /=\s*"([^"]+)"/g;
                            let m;
                            const types = [];
                            while ((m = regex.exec(content)) !== null) {
                                types.push("." + m[1]);
                            }
                            if (types.length > 0) {
                                setSupportedFileTypes(types);
                                console.log("Loaded supported file types:", types);
                            }
                        }
                    } catch (e) {
                        console.error("Failed to load supported file types", e);
                    }
                }
                loadSupportedFileTypes();
            }, []);
            const [imageFolderHandle, setImageFolderHandle] = useState(null);
            const [imageList, setImageList] = useState([]);
            const [isLoadingImages, setIsLoadingImages] = useState(false);
            const [annotationsFolderHandle, setAnnotationsFolderHandle] = useState(null);
            const [annotationsList, setAnnotationsList] = useState([]);
            const [isLoadingAnnotations, setIsLoadingAnnotations] = useState(false);
            const [annotationURL, setAnnotationURL] = useState("");
            const [activeTab, setActiveTab] = useState("Local Session");
            const [showSessionModal, setShowSessionModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false);

            useEffect(() => {
                // Create a new Pyodide worker
                workerPromise = new Promise((resolve, reject) => {
                    const workerManager = new PyodideWorkerManager();
                    workerManager.createWorker().then(worker => {
                        resolve(worker);
                    }).catch(error => {
                        console.error("Error creating Pyodide worker:", error);
                        reject(error);
                    });
                });
                // Get image folder handle from IndexedDB
                window.getFromDB("imageFolderDirHandle").then((dirHandle) => {
                    if (dirHandle) setImageFolderHandle(dirHandle);
                });
            }, []);

            const mountFolder = async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    setImageFolderHandle(dirHandle);
                } catch (error) {
                    console.error("Error accessing folder:", error);
                    alert("An error occurred while accessing the folder: " + error.message);
                }
            };

            const updateFileList = async (dirHandle, setFileList, setLoading, direction) => {
                setLoading(true);
                if (direction) {
                    try {
                        const pyodideWorker = await workerPromise;
                        await pyodideWorker.syncFs(direction);
                    } catch (error) {
                        console.error("Error syncing file system:", error);
                        throw error;
                    }
                }
                try {
                    const files = [];
                    for await (const entry of dirHandle.values()) {
                        if (entry.kind === "file") {
                            const fileType = entry.name.slice(entry.name.lastIndexOf(".")).toLowerCase();
                            if (supportedFileTypes.includes(fileType)) {
                                files.push(entry.name);
                            }
                        }
                    }
                    setFileList(files.sort());  // Sort files alphabetically
                } catch (error) {
                    console.error("Error updating file list:", error);
                    throw error;
                } finally {
                    setLoading(false);
                }
            };

            const updateAnnotationsList = async () => {
                setIsLoadingAnnotations(true);
                try {
                    const artifactId = localStorage.getItem("dataArtifactId");
                    if (artifactId && artifactManager) {
                         const files = await artifactManager.list_files(artifactId, "annotations");
                         const fileNames = files.map(f => f.name).sort();
                         setAnnotationsList(fileNames);
                    }
                } catch (error) {
                    console.error("Error listing remote annotations:", error);
                } finally {
                    setIsLoadingAnnotations(false);
                }
            };

            useEffect(() => {
                if (imageFolderHandle) {
                    window.saveToDB("imageFolderDirHandle", imageFolderHandle);
                    updateFileList(imageFolderHandle, setImageList, setIsLoadingImages);
                    console.log("Mounted folder:", imageFolderHandle.name);
                    setAnnotationsFolderHandle(null);
                    setAnnotationsList([]);
                    setAnnotationURL("");
                }
            }, [imageFolderHandle]);

            useEffect(() => {
                if (imageFolderHandle) {
                    updateFileList(imageFolderHandle, setImageList, setIsLoadingImages);
                }
            }, [supportedFileTypes]);

            const runCode = async (code) => {
                const pyodideWorker = await workerPromise;
                console.log("Running code:\n----------\n", code);
                try {
                    const result = await pyodideWorker.runScript(code);
                    handleResult(result);
                    return result;
                } catch (error) {
                    console.error("Error running code:", error);
                    throw error;
                }
            };

            const handleResult = (result) => {
                const stdout = result.filter(r => r.type === "stdout").map(r => r.content).join("");
                const stderr = result.filter(r => r.type === "stderr").map(r => r.content).join("");
                setPyodideOutput([stdout, stderr].filter(Boolean));
            };

            return (
                <div className="flex h-screen">
                    <Sidebar
                        user={user}
                        setUser={setUser}
                        activeTab={activeTab}
                        setActiveTab={setActiveTab}
                        setArtifactManager={setArtifactManager}
                    />
                    <div className="ml-64 flex-1 p-4">
                        <h2 className="text-2xl font-bold mb-4" style={{ height: "2rem", overflow: "hidden" }}>
                            BioImage.IO Colab: Annotate & Collaborate
                        </h2>
                        {isRunning && (
                            <div className="floating-spinner">
                                <div className="spinner-border"></div>
                            </div>
                        )}
                        {activeTab === "Local Session" && (
                            <LocalSession
                                user={user}
                                mountFolder={mountFolder}
                                updateFileList={updateFileList}
                                updateAnnotationsList={updateAnnotationsList}
                                imageFolderHandle={imageFolderHandle}
                                imageList={imageList}
                                setImageList={setImageList}
                                isLoadingImages={isLoadingImages}
                                setIsLoadingImages={setIsLoadingImages}
                                annotationsFolderHandle={annotationsFolderHandle}
                                annotationsList={annotationsList}
                                setAnnotationsList={setAnnotationsList}
                                isLoadingAnnotations={isLoadingAnnotations}
                                setIsLoadingAnnotations={setIsLoadingAnnotations}
                                annotationURL={annotationURL}
                                setShowSessionModal={setShowSessionModal}
                                setShowShareModal={setShowShareModal}
                                setActiveTab={setActiveTab}
                            />
                        )}

                        {activeTab === "Finetune Cellpose" && (
                            <FinetuneCellpose
                                user={user}
                                imageFolderHandle={imageFolderHandle}
                                imageList={imageList}
                                annotationsFolderHandle={annotationsFolderHandle}
                                annotationsList={annotationsList}
                                supportedFileTypes={supportedFileTypes}
                                setIsRunning={setIsRunning}
                                runCode={runCode}
                            />
                        )}

                        {activeTab === "Remote Deployment" && (
                            <RemoteDeployment />
                        )}

                        {activeTab === "Community Annotations" && (
                            <CommunityAnnotations />
                        )}
                    </div>

                    {showSessionModal && (
                        <SessionModal
                            setShowSessionModal={setShowSessionModal}
                            updateFileList={updateFileList}
                            imageFolderHandle={imageFolderHandle}
                            setImageList={setImageList}
                            setIsLoadingImages={setIsLoadingImages}
                            setAnnotationsFolderHandle={setAnnotationsFolderHandle}
                            setAnnotationsList={setAnnotationsList}
                            setIsLoadingAnnotations={setIsLoadingAnnotations}
                            setIsRunning={setIsRunning}
                            runCode={runCode}
                            supportedFileTypes={supportedFileTypes}
                            setAnnotationURL={setAnnotationURL}
                        />
                    )}

                    {showShareModal && (
                        <ShareModal
                            annotationURL={annotationURL}
                            setShowShareModal={setShowShareModal}
                        />
                    )}
                </div>
            );
        }

        function Sidebar({ user, setUser, activeTab, setActiveTab, setArtifactManager }) {
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [hyphaVersion, setHyphaVersion] = useState("");

            const useSavedToken = () => {
                const token = localStorage.getItem("token");
                if (token) {
                    const tokenExpiry = localStorage.getItem("tokenExpiry");
                    if (tokenExpiry && new Date(tokenExpiry) > new Date()) {
                        return token;
                    }
                }
                return null;
            }

            const loginCallback = (context) => {
                window.open(context.login_url);
            }

            const login = async () => {
                const token = await hyphaWebsocketClient.login({
                    "server_url": serverUrl,
                    "login_callback": loginCallback,
                });
                localStorage.setItem("token", token);
                localStorage.setItem("tokenExpiry", new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString());
                return token;
            }

            const handleLogin = async () => {
                setIsLoggingIn(true);
                let token
                token = useSavedToken();
                if (token) {
                    console.log("Using saved token.");
                } else {
                    token = await login();
                }
                try {
                    const server = await hyphaWebsocketClient.connectToServer({
                        "server_url": serverUrl,
                        "token": token,
                    });
                    const artifactManager = await server.getService("public/artifact-manager");
                    setArtifactManager(artifactManager);
                    setHyphaVersion(server.config.hyphaVersion);
                    setUser(server.config.user);
                    console.log("Logged in as:", server.config.user);
                } catch (error) {
                    console.error("Error connecting to server:", error);
                    // Clear token and tokenExpiry
                    localStorage.setItem("token", "");
                    localStorage.setItem("tokenExpiry", "");
                    // Retry login
                    handleLogin();
                } finally {
                    setIsLoggingIn(false);
                }
            };

            useEffect(() => {
                const savedToken = useSavedToken();
                if (savedToken) {
                    handleLogin();
                }
            }, []);

            return (
                <div className="bg-primary w-64 text-white p-4 fixed top-0 left-0 h-full">
                    <h1 className="text-xl font-semibold mb-4 text-center">
                        <i className="fas fa-project-diagram mr-2"></i>BioImage.IO Colab
                    </h1>

                    <div className="flex justify-center mb-4">
                        {user.email ? (
                            <span className="text-white py-2 rounded-md">
                                <i className="fas fa-user-circle mr-2"></i>
                                Welcome, {user.email}
                            </span>
                        ) : (
                            <button
                                className="bg-secondary text-white px-10 py-2 rounded-md btn-click-effect flex items-center justify-center"
                                onClick={handleLogin}
                            >
                                {isLoggingIn ? (
                                    <i className="fas fa-spinner fa-spin mr-2"></i>
                                ) : (
                                    <i className="fas fa-sign-in-alt mr-2"></i>
                                )}
                                Login
                            </button>
                        )}
                    </div>

                    <div className="separator"></div>

                    <ul>
                        <li
                            className={`mb-2 p-2 rounded-md cursor-pointer ${activeTab === "Local Session" ? "tab-active" : "bg-hover"}`}
                            onClick={() => setActiveTab("Local Session")}
                        >
                            <a href="#" className="text-white"><i className="fas fa-laptop mr-2"></i>Local Session</a>
                        </li>
                        <li
                            className={`mb-2 p-2 rounded-md cursor-pointer ${activeTab === "Finetune Cellpose" ? "tab-active" : "bg-hover"}`}
                            onClick={() => setActiveTab("Finetune Cellpose")}
                        >
                            <a href="#" className="text-white"><i className="fas fa-brain mr-2"></i>Finetune Cellpose</a>
                        </li>
                        <li
                            className={`mb-2 p-2 rounded-md cursor-pointer ${activeTab === "Remote Deployment" ? "tab-active" : "bg-hover"}`}
                            onClick={() => setActiveTab("Remote Deployment")}
                        >
                            <a href="#" className="text-white"><i className="fas fa-server mr-2"></i>Remote Deployment</a>
                        </li>
                        <li
                            className={`mb-2 p-2 rounded-md cursor-pointer ${activeTab === "Community Annotations" ? "tab-active" : "bg-hover"}`}
                            onClick={() => setActiveTab("Community Annotations")}
                        >
                            <a href="#" className="text-white"><i className="fas fa-users mr-2"></i>Community Annotations</a>
                        </li>
                    </ul>

                    {hyphaVersion && (
                        <div className="absolute bottom-4 left-4 text-sm italic">
                            <i className="fas fa-code-branch mr-2"></i>
                            Hypha Version: {hyphaVersion}
                        </div>
                    )}
                </div>
            );
        }

        function LocalSession({
            user,
            mountFolder,
            updateFileList,
            updateAnnotationsList,
            imageFolderHandle,
            imageList,
            setImageList,
            isLoadingImages,
            setIsLoadingImages,
            annotationsFolderHandle,
            annotationsList,
            setAnnotationsList,
            isLoadingAnnotations,
            setIsLoadingAnnotations,
            annotationURL,
            setShowSessionModal,
            setShowShareModal,
            setActiveTab,
        }) {
            const [isCollapsed, setIsCollapsed] = useState(false);

            const updateImages = async () => {
                await updateFileList(
                    imageFolderHandle,
                    setImageList,
                    setIsLoadingImages,
                    annotationsFolderHandle ? "native-to-browser" : null
                );
            };
            const updateAnnotations = async () => {
                if (updateAnnotationsList) {
                    await updateAnnotationsList();
                }
            };

            const createAnnotationSession = async () => {
                if (!user.email) {
                    alert("Please login first");
                    return;
                }
                setShowSessionModal(true);
            };

            const topHight = isCollapsed ? 258 : 450;
            const progressPercentage = annotationsList.length > 0 ? Math.round((annotationsList.length / imageList.length) * 100) : 0;

            return (
                <>
                    <div className="flex space-x-4">
                            

                        <div className="info-box">
                            <div 
                                className="info-box-title flex justify-between items-center cursor-pointer"
                                onClick={() => setIsCollapsed(!isCollapsed)}
                            >
                                <span className="flex-grow">Getting Started</span>
                                <i className={`ml-1 fas ${isCollapsed ? 'fa-chevron-down' : 'fa-chevron-up'}`}></i>
                            </div>
                            {!isCollapsed && (
                                <div className="info-box-text">
                                    <p className="mt-4">
                                        <strong>BioImage.IO Colab</strong> is an interactive,
                                        AI-powered annotation tool designed for collaborative
                                        annotation. Whether you're crowd-sourcing annotations or
                                        working within a team, this tool offers a streamlined way to
                                        manage and complete your image annotations efficiently.
                                    </p>
                                    <p>
                                        <strong>Step 1:</strong> Mount a local folder containing
                                        images for annotation. The data stays in your browser,
                                        ensuring full control over your files.
                                    </p>
                                    <p className="mt-2">
                                        <strong>Step 2:</strong> Create an annotation session to
                                        generate an annotation URL for the Kaibu tool. This URL can
                                        be shared with collaborators.
                                    </p>
                                    <p className="mt-2">
                                        <strong>Step 3:</strong> Share the annotation URL, and
                                        annotations will be automatically saved in the
                                        "annotations" folder within your mounted directory.
                                    </p>
                                    <p className="mt-4">
                                        <strong>Note:</strong> Closing this tab will stop the
                                        annotation session. Use the "Remote Deployments" feature
                                        (coming soon) to maintain active sessions.
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="flex items-center mb-4">
                        <div className="text-xl font-semibold mr-2">1.</div>
                        <button
                            className="bg-purple text-white px-4 py-2 rounded-md btn-click-effect"
                            onClick={mountFolder}
                        >
                            <i className="fas fa-folder-open mr-2"></i>
                            Mount Local Folder
                        </button>
                        <span className="mx-2 text-xl">→</span>

                        <div className="text-xl font-semibold mr-2">2.</div>
                        <button
                            className={`${imageList.length > 0 ? "bg-purple btn-click-effect" : "bg-disabled-button"
                                } text-white px-4 py-2 rounded-md`}
                            onClick={createAnnotationSession}
                            disabled={!imageList.length > 0}
                        >
                            <i className="fas fa-pen-alt mr-2"></i>
                            Create Annotation Session
                        </button>
                        <span className="mx-2 text-xl">→</span>

                        <div className="text-xl font-semibold mr-2">3.</div>
                        <button
                            id="share-url-button"
                            className={`${annotationURL ? "bg-purple btn-click-effect" : "bg-disabled-button"
                                } text-white px-4 py-2 rounded-md`}
                            onClick={() => setShowShareModal(true)}
                            disabled={!annotationURL}
                        >
                            <i className="fas fa-share-alt mr-2"></i>
                            Share Annotation URL
                        </button>
                        <span className="mx-2 text-xl">→</span>

                        <div className="text-xl font-semibold mr-2">4.</div>
                        <button
                            className={`${annotationsList.length > 0 ? "bg-green btn-click-effect" : "bg-disabled-button"
                                } text-white px-4 py-2 rounded-md`}
                            onClick={() => setActiveTab("Finetune Cellpose")}
                            disabled={annotationsList.length === 0}
                        >
                            <i className="fas fa-brain mr-2"></i>
                            Finetune Model
                        </button>
                    </div>

                    <div className="flex space-x-4">
                        {imageFolderHandle && (
                            <div
                                className="bg-primary w-1/2 p-4 rounded-md overflow-auto"
                                style={{ maxHeight: `calc(100vh - ${topHight}px)`}}
                            >
                                <div className="flex justify-between items-center mb-2">
                                    <h2 className="text-xl font-semibold text-white">
                                        Images ({imageList.length})
                                    </h2>
                                    <button
                                        className="btn-click-effect"
                                        onClick={updateImages}
                                    >
                                        <i className="fas fa-sync-alt text-white"></i>
                                    </button>
                                </div>
                                {isLoadingImages ? (
                                    <div className="flex justify-center items-center h-full">
                                        <div className="spinner-border"></div>
                                    </div>
                                ) : (
                                    <ul>
                                        {imageList.length > 0 ? (
                                            imageList.map((file, index) => (
                                                <li key={index} className="text-white flex items-center">
                                                    <i className="fas fa-image mr-2"></i>
                                                    {file}
                                                </li>
                                            ))
                                        ) : (
                                            <li className="text-white">No images found.</li>
                                        )}
                                    </ul>
                                )}
                            </div>
                        )}
                        {imageFolderHandle && (
                            <div
                                className="w-1/2 bg-primary p-4 rounded-md overflow-auto"
                                style={{ maxHeight: `calc(100vh - ${topHight}px)`}}
                            >
                                <div className="flex justify-between items-center mb-2">
                                    <h2 className="text-xl font-semibold text-white">
                                        Annotations ({annotationsList.length})
                                    </h2>
                                    <button
                                        className="btn-click-effect"
                                        onClick={updateAnnotations}
                                    >
                                        <i className="fas fa-sync-alt text-white"></i>
                                    </button>
                                </div>
                                {isLoadingAnnotations ? (
                                    <div className="flex justify-center items-center h-full">
                                        <div className="spinner-border"></div>
                                    </div>
                                ) : (
                                    <ul>
                                        {annotationsList.length > 0 ? (
                                            annotationsList.map((file, index) => (
                                                <li key={index} className="text-white flex items-center">
                                                    <i className="fas fa-image mr-2"></i>
                                                    {file}
                                                </li>
                                            ))
                                        ) : (
                                            <li className="text-white">No annotations found.</li>
                                        )}
                                    </ul>
                                )}
                            </div>
                        )}
                    </div>
                    <div
                        className="progress-bar mt-4 mb-4"
                        style={{ width: `${progressPercentage}%` }}
                    ></div>
                    <div className="text-sm font-semibold text-gray-600 mb-4">
                        {`Annotated ${annotationsList.length} out of ${imageList.length} images`}
                    </div>
                </>
            );
        }

        function RemoteDeployment() {
            return (
                <div className="flex justify-center items-center h-full">
                    <div className="text-xl flex items-center">
                        <i className="fas fa-tools mr-2"></i>
                        <span className="font-semibold">Remote Deployment</span>&nbsp;is coming soon.
                    </div>
                </div>
            );
        }

        function CommunityAnnotations() {
            const [token, setToken] = useState(localStorage.getItem("token"));
            const [annotationServices, setAnnotationServices] = useState([]);

            useEffect(() => {
                const fetchAnnotations = async () => {
                    try {
                        const token = localStorage.getItem("token");
                        setToken(token);
                        const server = await hyphaWebsocketClient.connectToServer({
                            "server_url": serverUrl,
                            "token": token,
                        });
                        const services = await server.listServices({ "type": "annotation-data-provider" });
                        setAnnotationServices(services);
                        await server.disconnect();
                    } catch (error) {
                        console.error("Error fetching annotation services:", error);
                    }
                };

                fetchAnnotations();
            }, [serverUrl]);

            return (
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {annotationServices.length > 0 ? (
                        annotationServices.map((service) => {
                            const configStr = `{"serverUrl": "${serverUrl}", "imageProviderId": "${service.id}"}`;  // "token": "${token}"
                            const encodedConfig = encodeURIComponent(configStr);
                            const annotatorUrl = `https://imjoy.io/lite?plugin=${pluginUrl}&config=${encodedConfig}`;

                            return (
                                <div key={service.id} className="bg-white shadow-md rounded-lg p-4">
                                    <h3 className="text-lg font-semibold mb-2">{service.name}</h3>
                                    <p className="text-sm text-gray-600 mb-4">{service.description}</p>
                                    <a
                                        href={annotatorUrl}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="bg-secondary text-white px-4 py-2 rounded-md"
                                    >
                                        Launch
                                    </a>
                                </div>
                            );
                        })
                    ) : (
                        <p className="text-center text-gray-500 col-span-4">No annotation sessions available.</p>
                    )}
                </div>
            );
        }

        function FinetuneCellpose({
            user,
            imageFolderHandle,
            imageList,
            annotationsFolderHandle,
            annotationsList,
            supportedFileTypes,
            setIsRunning,
            runCode,
        }) {
            const [isUploading, setIsUploading] = useState(false);
            const [uploadStatus, setUploadStatus] = useState("");
            const [artifactId, setArtifactId] = useState("");
            
            // Finetuning state
            const [isFinetuning, setIsFinetuning] = useState(false);
            const [finetuneStatus, setFinetuneStatus] = useState("");
            const [baseModel, setBaseModel] = useState(localStorage.getItem("baseModel") || "cyto3");
            const [nEpochs, setNEpochs] = useState(localStorage.getItem("nEpochs") || "10");
            const [learningRate, setLearningRate] = useState(localStorage.getItem("learningRate") || "1e-6");
            const [sessionId, setSessionId] = useState("");

            // Reset artifact ID when folder changes
            useEffect(() => {
                setArtifactId("");
                setUploadStatus("");
            }, [imageFolderHandle]);

            const uploadAnnotations = async () => {
                if (!user.email) {
                    alert("Please login first");
                    return;
                }

                if (!imageFolderHandle || !annotationsFolderHandle) {
                    alert("Please mount a local folder with annotations first (Local Session tab)");
                    return;
                }

                if (imageList.length === 0 || annotationsList.length === 0) {
                    alert("No images or annotations found to upload");
                    return;
                }

                setIsUploading(true);
                setUploadStatus(artifactId ? "Updating artifact..." : "Creating new artifact...");

                try {
                    const token = localStorage.getItem("token");
                    setIsRunning(true);

                    // Load the service code
                    const code = await fetch(`./${serviceFile}`).then(response => response.text());
                    await runCode(code);

                    // Mount the folders to the pyodide worker
                    const pyodideWorker = await workerPromise;
                    await pyodideWorker.mount("/mnt", imageFolderHandle);

                    setUploadStatus("Uploading data to artifact...");

                    // Prepare the supported file types
                    const supportedFileTypesJson = JSON.stringify(supportedFileTypes).replace(/"/g, '\\"');

                    // Call create_data_artifact - use existing artifact ID if available, otherwise create new
                    const artifactIdParam = artifactId ? `"${artifactId}"` : "None";
                    const outputs = await runCode(
                        `await create_data_artifact("${serverUrl}", "${token}", ${artifactIdParam}, "/mnt", "/mnt/annotations", "${supportedFileTypesJson}")`
                    );

                    // Extract the artifact ID from the output
                    const returnOutput = outputs.find(output => output.type === "return");
                    if (returnOutput && returnOutput.value) {
                        const newArtifactId = returnOutput.value;
                        setArtifactId(newArtifactId);
                        setUploadStatus(`Successfully ${artifactId ? 'updated' : 'created'} artifact: ${newArtifactId}`);
                        return newArtifactId;
                    } else {
                        setUploadStatus("Upload completed, but artifact ID not found in output");
                        return null;
                    }
                } catch (error) {
                    console.error("Error uploading annotations:", error);
                    setUploadStatus(`Error: ${error.message}`);
                    return null;
                } finally {
                    setIsRunning(false);
                    setIsUploading(false);
                }
            };

            const startFinetuning = async () => {
                if (!artifactId) {
                    alert("Please upload annotations first to create an artifact");
                    return;
                }

                if (!user.email) {
                    alert("Please login first");
                    return;
                }

                setIsFinetuning(true);
                setFinetuneStatus("Starting finetuning...");

                try {
                    const token = localStorage.getItem("token");
                    setIsRunning(true);

                    // Load the service code if not already loaded
                    const code = await fetch(`./${serviceFile}`).then(response => response.text());
                    await runCode(code);

                    setFinetuneStatus("Submitting training job...");

                    // Call finetune_cellpose
                    const outputs = await runCode(
                        `await finetune_cellpose("${serverUrl}", "${token}", "${artifactId}", "${baseModel}")`
                    );

                    // Extract the session ID from the output
                    const returnOutput = outputs.find(output => output.type === "return");
                    if (returnOutput && returnOutput.value) {
                        const newSessionId = returnOutput.value;
                        setSessionId(newSessionId);
                        setFinetuneStatus(`Training completed! Session ID: ${newSessionId}`);
                    } else {
                        setFinetuneStatus("Training process completed");
                    }
                } catch (error) {
                    console.error("Error finetuning model:", error);
                    setFinetuneStatus(`Error: ${error.message}`);
                } finally {
                    setIsRunning(false);
                    setIsFinetuning(false);
                }
            };

            // Save model parameters to localStorage
            useEffect(() => {
                localStorage.setItem("baseModel", baseModel);
                localStorage.setItem("nEpochs", nEpochs);
                localStorage.setItem("learningRate", learningRate);
            }, [baseModel, nEpochs, learningRate]);

            // Calculate number of images with annotations
            const getImagesWithAnnotations = () => {
                const imagesWithAnnotations = new Set();
                annotationsList.forEach(annotationFile => {
                    // Extract image name from annotation file (e.g., "image_name_mask_1.tif" -> "image_name")
                    const match = annotationFile.match(/^(.+)_mask_\d+\.(tif|tiff)$/i);
                    if (match) {
                        const imageName = match[1];
                        // Check if corresponding image exists
                        const hasImage = imageList.some(img => {
                            const imgNameWithoutExt = img.replace(/\.(tif|tiff)$/i, '');
                            return imgNameWithoutExt === imageName;
                        });
                        if (hasImage) {
                            imagesWithAnnotations.add(imageName);
                        }
                    }
                });
                return imagesWithAnnotations.size;
            };

            const imagesWithAnnotationsCount = getImagesWithAnnotations();

            return (
                <div>
                    <div className="info-box mb-4">
                        <div className="info-box-title">
                            <i className="fas fa-brain mr-2"></i>Finetune Cellpose Model
                        </div>
                        <p className="info-box-text mt-2">
                            Upload your locally collected annotations to create a training dataset, then finetune a Cellpose model
                            with your custom annotations. The process involves two steps: first uploading data to create an artifact,
                            then starting the finetuning job on the remote server.
                        </p>
                    </div>

                    {/* Step 1: Upload Annotations */}
                    <div className="bg-white shadow-md rounded-lg p-6 mb-4">
                        <h3 className="text-xl font-semibold mb-4">
                            <span className="bg-purple text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-2">1</span>
                            Upload Training Data
                        </h3>
                        <div className="mb-4">
                            <p className="text-gray-700 mb-2">
                                <strong>Images with annotations:</strong> {imagesWithAnnotationsCount} files
                            </p>
                            <p className="text-gray-700 mb-2">
                                <strong>Annotation masks:</strong> {annotationsList.length} files
                            </p>
                            {artifactId && (
                                <p className="text-gray-700 mb-2">
                                    <strong>Artifact ID:</strong> {artifactId}
                                </p>
                            )}
                        </div>

                        {uploadStatus && (
                            <div className={`p-4 rounded-md mb-4 ${uploadStatus.startsWith("Error") ? "bg-red-100 text-red-700" : "bg-green-100 text-green-700"}`}>
                                {uploadStatus}
                            </div>
                        )}

                        <button
                            className={`${!isUploading && !isFinetuning && imageList.length > 0 && annotationsList.length > 0 ? "bg-purple btn-click-effect" : "bg-disabled-button"} text-white px-6 py-3 rounded-md flex items-center`}
                            onClick={uploadAnnotations}
                            disabled={isUploading || isFinetuning || imageList.length === 0 || annotationsList.length === 0}
                        >
                            {isUploading ? (
                                <i className="fas fa-spinner fa-spin mr-2"></i>
                            ) : (
                                <i className={`fas ${artifactId ? 'fa-sync-alt' : 'fa-cloud-upload-alt'} mr-2`}></i>
                            )}
                            {isUploading ? 'Uploading...' : (artifactId ? 'Update Training Data' : 'Upload Training Data')}
                        </button>
                    </div>

                    {/* Step 2: Finetune Model */}
                    <div className="bg-white shadow-md rounded-lg p-6 mb-4">
                        <h3 className="text-xl font-semibold mb-4">
                            <span className="bg-purple text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-2">2</span>
                            Start Finetuning
                        </h3>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Base Model:
                                </label>
                                <select
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    value={baseModel}
                                    onChange={(e) => setBaseModel(e.target.value)}
                                    disabled={isUploading || isFinetuning}
                                >
                                    <option value="cyto3">cyto3</option>
                                    <option value="cyto2">cyto2</option>
                                    <option value="cyto">cyto</option>
                                    <option value="nuclei">nuclei</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Number of Epochs:
                                </label>
                                <input
                                    type="number"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    value={nEpochs}
                                    onChange={(e) => setNEpochs(e.target.value)}
                                    min="1"
                                    max="100"
                                    disabled={isUploading || isFinetuning}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Learning Rate:
                                </label>
                                <input
                                    type="text"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    value={learningRate}
                                    onChange={(e) => setLearningRate(e.target.value)}
                                    placeholder="1e-6"
                                    disabled={isUploading || isFinetuning}
                                />
                            </div>
                        </div>

                        {finetuneStatus && (
                            <div className={`p-4 rounded-md mb-4 ${finetuneStatus.startsWith("Error") ? "bg-red-100 text-red-700" : "bg-blue-100 text-blue-700"}`}>
                                {finetuneStatus}
                            </div>
                        )}

                        {sessionId && (
                            <div className="p-4 rounded-md mb-4 bg-green-100 text-green-700">
                                <strong>Training Session ID:</strong> {sessionId}
                            </div>
                        )}

                        <button
                            className={`${!isUploading && !isFinetuning && artifactId ? "bg-green btn-click-effect" : "bg-disabled-button"} text-white px-6 py-3 rounded-md`}
                            onClick={startFinetuning}
                            disabled={isUploading || isFinetuning || !artifactId}
                        >
                            <i className="fas fa-play-circle mr-2"></i>
                            Start Finetuning
                        </button>
                    </div>

                    <div className="info-box">
                        <div className="info-box-title">
                            <i className="fas fa-info-circle mr-2"></i>How it works
                        </div>
                        <ul className="info-box-text mt-2 list-disc list-inside space-y-1">
                            <li><strong>Step 1:</strong> Upload your images and annotations to create a training artifact</li>
                            <li>Images and masks are converted to numpy format and paired automatically</li>
                            <li><strong>Step 2:</strong> Configure and start the Cellpose finetuning job</li>
                            <li>Select a base model (cyto3 recommended for cell segmentation)</li>
                            <li>Adjust training parameters like epochs and learning rate</li>
                            <li>The training runs on a remote server and you'll receive a session ID to track progress</li>
                            <li>Once complete, your finetuned model can be used for inference</li>
                        </ul>
                    </div>
                </div>
            );
        }

        function SessionModal({
            setShowSessionModal,
            updateFileList,
            imageFolderHandle,
            setImageList,
            setIsLoadingImages,
            setAnnotationsFolderHandle,
            setAnnotationsList,
            setIsLoadingAnnotations,
            setIsRunning,
            runCode,
            supportedFileTypes,
            setAnnotationURL,
        }) {
            const [isCreatingSession, setIsCreatingSession] = useState(false);
            const [sessionName, setSessionName] = useState(localStorage.getItem("sessionName") || "");
            const [sessionDescription, setSessionDescription] = useState(localStorage.getItem("sessionDescription") || "");

            const handleCreateSession = async () => {
                setIsCreatingSession(true);
                const token = localStorage.getItem("token");
                localStorage.setItem("sessionName", sessionName);
                localStorage.setItem("sessionDescription", sessionDescription);

                // Start annotation session
                try {
                    setIsRunning(true);
                    // Load the service code
                    const code = await fetch(`./${serviceFile}`).then(response => response.text());
                    await runCode(code);
                    // Mount the image folder to the pyodide worker
                    const pyodideWorker = await workerPromise;
                    await pyodideWorker.mount("/mnt", imageFolderHandle);
                    // Register the service
                    const outputs = await runCode(
                        `await register_service(server_url="${serverUrl}", token="${token}", name="${sessionName}", description="${sessionDescription}")`
                    );

                    const artifactIdOutput = outputs.find(output => output.type === "stdout" && output.content.includes("Data Artifact ID:"));
                    const artifactId = artifactIdOutput ? artifactIdOutput.content.split("Data Artifact ID:")[1].trim() : null;

                    if (!artifactId) {
                       console.error("Artifact ID not found in outputs:", outputs);
                        throw new Error("Something went wrong while registering the service."); 
                    }
                    console.log("Data Artifact ID:", artifactId);
                    localStorage.setItem("dataArtifactId", artifactId);

                    const serviceIdOutput = outputs.find(output => output.type === "stdout" && output.content.includes("Data Provider Service ID:"));
                    const annotationSid = serviceIdOutput ? serviceIdOutput.content.split("Data Provider Service ID:")[1].trim() : null;

                    if (!annotationSid) {
                        console.error("Service ID not found in outputs:", outputs);
                        throw new Error("Something went wrong while registering the service.");
                    }
                    console.log("Annotation Service ID:", annotationSid);

                    // Create the annotator URL
                    const configStr = `{"serverUrl": "${serverUrl}", "imageProviderId": "${annotationSid}"}`;  // "token": "${token}"
                    const encodedConfig = encodeURIComponent(configStr);
                    const annotatorUrl = `https://imjoy.io/lite?plugin=${pluginUrl}&config=${encodedConfig}`;
                    console.log("Annotation URL:\n----------\n", annotatorUrl);
                    setAnnotationURL(annotatorUrl);
                    // Ensure that the same image files are displayed that were mounted to pyodide (sync native ==> browser is called in runCode)
                    updateFileList(imageFolderHandle, setImageList, setIsLoadingImages)
                    // Run the event loop to keep the service running
                    await runCode(`import asyncio; loop = asyncio.get_event_loop(); loop.run_forever()`);
                }
                catch (error) {
                    console.error("Error registering service:", error);
                    throw error;
                }
                finally {
                    setIsRunning(false);
                    setShowSessionModal(false);
                    setIsCreatingSession(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">Create Annotation Session</div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">
                                Session Name
                            </label>
                            <input
                                type="text"
                                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                value={sessionName}
                                onChange={(e) => setSessionName(e.target.value)}
                            />
                        </div>
                        <div className="mt-4">
                            <label className="block text-sm font-medium text-gray-700">
                                Description
                            </label>
                            <textarea
                                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                rows="4"
                                value={sessionDescription}
                                onChange={(e) => setSessionDescription(e.target.value)}
                            ></textarea>
                        </div>
                        <div className="mt-4 flex items-center">
                            <span className="mr-2">Public</span>
                            <input type="checkbox" checked disabled />
                        </div>
                        <div className="modal-footer">
                            <button
                                className="bg-gray-500 text-white px-4 py-2 rounded-md"
                                onClick={() => setShowSessionModal(false)}
                                disabled={isCreatingSession}
                            >
                                Cancel
                            </button>
                            <button
                                className="bg-secondary text-white px-4 py-2 rounded-md flex items-center"
                                onClick={handleCreateSession}
                                disabled={isCreatingSession || !sessionName}
                            >
                                {isCreatingSession && <i className="fas fa-spinner fa-spin mr-2"></i>}
                                Create
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function ShareModal({ annotationURL, setShowShareModal }) {
            const [copyFeedback, setCopyFeedback] = useState("Copy URL");
            useEffect(() => {
                // Initialize the QR code when the modal is displayed
                new QRCode(document.getElementById('annotation-url-qrcode'), {
                    text: annotationURL,  // Use the annotation URL for the QR code
                    width: 600,
                    height: 600,
                    colorDark: '#000',
                    colorLight: '#fff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }, [annotationURL]);  // Trigger this effect when annotationURL changes
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-header">Share Annotation URL</div>
                        <div className="modal-body flex flex-col items-center">
                            <div id="annotation-url-qrcode" className="mb-4"></div> {/* QR code will be generated here */}
                        </div>
                        <div className="modal-footer">
                            <button
                                className="bg-secondary text-white px-4 py-2 rounded-md"
                                onClick={() => {
                                    navigator.clipboard.writeText(annotationURL);
                                    setCopyFeedback("URL copied!");
                                    setTimeout(() => setCopyFeedback("Copy URL"), 3000);
                                }}
                            >
                                {copyFeedback}
                            </button>
                            <a
                                href={annotationURL}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="bg-accent text-white px-4 py-2 rounded-md"
                            >
                                Open URL
                            </a>
                            <button
                                className="bg-gray-500 text-white px-4 py-2 rounded-md"
                                onClick={() => setShowShareModal(false)}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("app"));
    </script>
</body>

</html>
