<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioimgeIO Colab</title>
    <script src="https://cdn.jsdelivr.net/npm/hypha-rpc@latest/dist/hypha-rpc.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hypha-rpc@latest/dist/hypha-rpc-websocket.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define color variables */
        :root {
            --color-turquoise: #95B0AD;
            --color-blue: #314966;
            --color-purple: #471C4D;
            --color-green: #07332E;
        }

        .bg-turquoise { background-color: var(--color-turquoise); }
        .bg-blue { background-color: var(--color-blue); }
        .bg-purple { background-color: var(--color-purple); }
        .bg-green { background-color: var(--color-green); }

        /* Hover states with 50% transparency */
        .bg-turquoise-hover:hover { background-color: rgba(149, 176, 173, 0.3); }
        .bg-blue-hover:hover { background-color: rgba(49, 73, 102, 0.3); }
        .bg-purple-hover:hover { background-color: rgba(71, 28, 77, 0.3); }
        .bg-green-hover:hover { background-color: rgba(7, 51, 46, 0.3); }
    
        .spinner-border {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--color-blue);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s infinite linear;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .tab-active {
            background-color: var(--color-turquoise);
            border-radius: 0.5rem;
            color: white;
        }
        .separator {
            border-top: 1px solid #555;
            margin: 1rem 0;
        }
    </style>
    <script src="./worker-manager.js"></script>
</head>
<body>
<div id="app"></div>

<script type="text/babel" data-presets="env,react">
    const { useState, useEffect } = React;

    const PYTHON_FILE_NAME = 'provide_images.py';

    function App() {
        const [serverURL, setServerURL] = useState("wss://hypha.aicell.io/ws");
        const [pyodideWorker, setPyodideWorker] = useState(null);
        const [code, setCode] = useState("");
        const [user, setUser] = useState({});
        const [imageFolderHandle, setImageFolderHandle] = useState(null);
        const [imageList, setImageList] = useState([]);
        const [annotationsFolderHandle, setAnnotationsFolderHandle] = useState(null);
        const [annotationsList, setAnnotationsList] = useState([]);
        const [isLoadingWorker, setIsLoadingWorker] = useState(true);
        const [isLoadingImages, setIsLoadingImages] = useState(false);
        const [isLoadingAnnotations, setIsLoadingAnnotations] = useState(false);
        const [annotationURL, setAnnotationURL] = useState("");
        const [copyFeedback, setCopyFeedback] = useState("");
        const [activeTab, setActiveTab] = useState("Local Deployment");

        useEffect(() => {
            const workerManager = new PyodideWorkerManager();
            workerManager.createWorker().then(worker => {
                setPyodideWorker(worker);
                setIsLoadingWorker(false); // Hide spinner when worker is ready
            }).catch(error => {
                console.error("Error creating Pyodide worker:", error);
            });

            fetch(`./${PYTHON_FILE_NAME}`)
                .then(response => response.text())
                .then(text => {
                    setCode(text);
                })
                .catch(error => {
                    console.error(`Error loading ${PYTHON_FILE_NAME}:`, error);
                });
        }, []);

        const login_callback = (context) => {
            window.open(context.login_url);
        }

        const login = async () => {
            let token = localStorage.getItem('token');
            if (token) {
                const tokenExpiry = localStorage.getItem('tokenExpiry');
                if (tokenExpiry && new Date(tokenExpiry) > new Date()) {
                    console.log("Using saved token:", token);
                    return token;
                }
            }
            token = await hyphaWebsocketClient.login({
                "server_url": serverURL,
                "login_callback": login_callback,
            });
            localStorage.setItem('token', token);
            localStorage.setItem('tokenExpiry', new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString());
            return token;
        }

        const onLogin = async () => {
            const token = await login();
            const server = await hyphaWebsocketClient.connectToServer({
                "server_url": serverURL,
                "token": token
            });
            setUser(server.config.user);
            console.log("Logged in as:", server.config.user);
        };

        const updateFileList = async (dirHandle, setFileList, setLoading) => {
            setLoading(true);
            try {
                const files = [];
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') {
                        files.push(entry.name);
                    }
                }
                setFileList(files.sort()); // Sort files alphabetically
            } catch (error) {
                console.error("Error updating file list:", error);
            } finally {
                setLoading(false);
            }
        };

        const mountFolder = async () => {
            try {
                const dirHandle = await window.showDirectoryPicker();
                setImageFolderHandle(dirHandle);
                await updateFileList(dirHandle, setImageList, setIsLoadingImages); // Update image list
                console.log("Mounted folder:", dirHandle.name);
            } catch (error) {
                console.error("Error accessing folder:", error);
            }
        };

        const runCode = async () => {
            if (pyodideWorker) {
                const result = await pyodideWorker.runScript(code);
                handleResult(result);
            } else {
                console.log("Pyodide worker not ready");
            }
        };

        const handleResult = (result) => {
            const stdout = result.filter(r => r.type === 'stdout').map(r => r.content).join("");
            const stderr = result.filter(r => r.type === 'stderr').map(r => r.content).join("");
            setOutput([stdout, stderr].filter(Boolean));
        };

        const createAnnotationSession = async () => {
            if (imageFolderHandle) {
                try {
                    const annotationsFolder = await imageFolderHandle.getDirectoryHandle('annotations', { create: true });
                    setAnnotationsFolderHandle(annotationsFolder);
                    await updateFileList(annotationsFolder, setAnnotationsList, setIsLoadingAnnotations); // Update annotations list
                    console.log("Created annotations folder:", annotationsFolder.name);
                } catch (error) {
                    console.error("Error creating annotations folder:", error);
                }
                // Run code to start annotation session
                try {
                    // await runCode();
                    // TODO: get annotator_url from stdout
                    // Placeholder for setting annotationURL
                    setAnnotationURL("http://example.com/annotation-session-url"); // Replace with actual URL
                } catch (error) {
                    console.error("Error running Python code:", error);
                }
            }
        };

        const shareAnnotationURL = async () => {
            if (!annotationURL) return;

            setCopyFeedback("Copying Annotation URL...");
            // Disable button while copying
            const button = document.querySelector("#share-url-button");
            button.disabled = true;

            try {
                await navigator.clipboard.writeText(annotationURL);
                setTimeout(() => {
                    setCopyFeedback("Copied Annotation URL!");
                    // Re-enable button after feedback time
                    setTimeout(() => {
                        setCopyFeedback("");
                        button.disabled = false;
                    }, 5000);
                }, 1000);
            } catch (err) {
                console.error("Failed to copy annotation URL:", err);
                setCopyFeedback("");
                button.disabled = false;
            }
        };

        const isImageFolderMounted = imageFolderHandle !== null;
        const isAnnotationSessionCreated = annotationsFolderHandle !== null;

        return (
            <div className="flex h-screen">
                <Sidebar
                    onLogin={onLogin}
                    user={user}
                    activeTab={activeTab}
                    onTabClick={setActiveTab}
                />
                <div className="flex-1 p-4">
                    <h1 className="text-2xl font-bold mb-4">Crowd-sourcing Annotation Tool</h1>
                    {isLoadingWorker ? (
                        <div className="flex justify-center items-center h-full">
                            <div className="spinner-border"></div>
                        </div>
                    ) : (
                        <>
                            {activeTab === "Local Deployment" && (
                                <>
                                    <div className="flex items-center mb-4">
                                        <div className="text-xl font-semibold mr-2">1.</div>
                                        <button 
                                            className="bg-purple text-white px-4 py-2 rounded-md"
                                            onClick={mountFolder}
                                        >
                                            Mount Local Folder
                                        </button>
                                        <span className="mx-2 text-xl">→</span>

                                        <div className="text-xl font-semibold mr-2">2.</div>
                                        <button 
                                            className="bg-purple text-white px-4 py-2 rounded-md"
                                            onClick={createAnnotationSession}
                                            disabled={!isImageFolderMounted}
                                        >
                                            Create Annotation Session
                                        </button>
                                        <span className="mx-2 text-xl">→</span>

                                        <div className="text-xl font-semibold mr-2">3.</div>
                                        <button 
                                            id="share-url-button"
                                            className="bg-purple text-white px-4 py-2 rounded-md"
                                            onClick={shareAnnotationURL}
                                            disabled={!isAnnotationSessionCreated}
                                        >
                                            {copyFeedback || "Share Annotation URL"}
                                        </button>
                                    </div>

                                    <div className="flex space-x-4">
                                        {isImageFolderMounted && (
                                            <div className="bg-blue w-1/2 p-4 rounded-md overflow-auto"
                                                style={{ maxHeight: 'calc(100vh - 140px)', width: '50%' }}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <h2 className="text-xl font-semibold">Number of Images: ({imageList.length})</h2>
                                                    <button onClick={() => updateFileList(imageFolderHandle, setImageList, setIsLoadingImages)}>
                                                        <i className="fas fa-sync-alt text-white"></i>
                                                    </button>
                                                </div>
                                                {isLoadingImages ? (
                                                    <div className="flex justify-center items-center h-full">
                                                        <div className="spinner-border"></div>
                                                    </div>
                                                ) : (
                                                    <ul>
                                                        {imageList.length > 0 ? (
                                                            imageList.map((file, index) => (
                                                                <li key={index} className="text-white">{file}</li>
                                                            ))
                                                        ) : (
                                                            <li className="text-white">No files found.</li>
                                                        )}
                                                    </ul>
                                                )}
                                            </div>
                                        )}

                                        {annotationsFolderHandle && (
                                            <div className="w-1/2 bg-blue p-4 rounded-md overflow-auto"
                                                style={{ maxHeight: 'calc(100vh - 140px)', width: '50%' }}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <h2 className="text-xl font-semibold">Number of Annotations: ({annotationsList.length})</h2>
                                                    <button onClick={() => updateFileList(annotationsFolderHandle, setAnnotationsList, setIsLoadingAnnotations)}>
                                                        <i className="fas fa-sync-alt text-white"></i>
                                                    </button>
                                                </div>
                                                {isLoadingAnnotations ? (
                                                    <div className="flex justify-center items-center h-full">
                                                        <div className="spinner-border"></div>
                                                    </div>
                                                ) : (
                                                    <ul>
                                                        {annotationsList.length > 0 ? (
                                                            annotationsList.map((file, index) => (
                                                                <li key={index} className="text-white">{file}</li>
                                                            ))
                                                        ) : (
                                                            <li className="text-white">No files found.</li>
                                                        )}
                                                    </ul>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}

                            {activeTab === "Remote Deployment" && (
                                <div className="flex justify-center items-center h-full">
                                    <div className="text-xl flex items-center">
                                        <i className="fas fa-tools mr-2"></i>
                                        <span className="font-semibold">Remote Deployment</span>&nbsp;is coming soon.
                                    </div>
                                </div>
                            )}

                            {activeTab === "My Deployments" && (
                                <div className="flex justify-center items-center h-full">
                                    <div className="text-xl flex items-center">
                                        <i className="fas fa-tools mr-2"></i>
                                        <span className="font-semibold">My Deployments</span>&nbsp;is coming soon.
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                </div>
            </div>
        );
    }

    function Sidebar({ onLogin, user, activeTab, onTabClick }) {
        return (
            <div className="bg-blue w-64 text-white p-4 relative">
                <h1 className="text-xl font-semibold mb-4 text-center">Navigation</h1>

                <div className="flex justify-center mb-4">
                    {user.email ? (
                        <span className="text-white py-2 rounded-md">
                            Welcome, {user.email}
                        </span>
                    ) : (
                        <button 
                            className="bg-turquoise text-white px-10 py-2 rounded-md"
                            onClick={onLogin}
                        >
                            Login
                        </button>
                    )}
                </div>

                <div className="separator"></div>
                
                <ul>
                    <li 
                    className={`mb-2 p-2 rounded-md cursor-pointer ${activeTab === "Local Deployment" ? "tab-active" : "bg-turquoise-hover"}`}
                        onClick={() => onTabClick("Local Deployment")}
                    >
                        <a href="#" className="text-white">Local Deployment</a>
                    </li>
                    <li 
                        className={`mb-2 p-2 rounded-md cursor-pointer ${activeTab === "Remote Deployment" ? "tab-active" : "bg-turquoise-hover"}`}
                        onClick={() => onTabClick("Remote Deployment")}
                    >
                        <a href="#" className="text-white">Remote Deployment</a>
                    </li>
                    <li 
                        className={`mb-2 p-2 rounded-md cursor-pointer ${activeTab === "My Deployments" ? "tab-active" : "bg-turquoise-hover"}`}
                        onClick={() => onTabClick("My Deployments")}
                    >
                        <a href="#" className="text-white">My Deployments</a>
                    </li>
                </ul>
            </div>
        );
    }

    ReactDOM.render(<App />, document.getElementById('app'));
</script>
</body>
</html>
